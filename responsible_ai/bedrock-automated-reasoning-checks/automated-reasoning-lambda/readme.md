
# Amazon Bedrock Automated Reasoning checks with Lambda

This sample demonstrates how to implement Amazon Bedrock Automated Reasoning checks capabilities within AWS Lambda functions. Automated Reasoning allows you to validate content against logical rules and policies, ensuring compliance with business requirements and preventing factual inaccuracies in AI-generated content.

## Features

- Load custom Bedrock service models in a Lambda function
- Create and manage guardrails with Automated Reasoning policies
- Apply guardrails to validate content against logical rules
- Process and interpret the validation results
- Generate corrected responses based on Automated Reasoning results and feedbacks

## Prerequisites

- AWS Account with access to Amazon Bedrock service
- Access to Automated Reasoning capabilities in AWS Bedrock (private preview feature)
- Lambda execution role with appropriate permissions for Bedrock services
- Foundation model access for corrected response generation
- Basic understanding of Python and AWS Lambda functions

## Setup Instructions

1. **Create a Lambda Function**
   - Create a new Lambda function using Python 3.9 or later
   - Set appropriate memory (recommended: at least 256MB) and timeout (recommended: at least 30 seconds)

2. **Package the Lambda Function**
   - Create a directory structure with the following:
     ```
     lambda_package/
     ├── lambda_function.py
     └── models/
         ├── bedrock-2023-04-20.api.json
         └── bedrock-runtime-2023-09-30.api.json
     ```
   - Copy the provided code into `lambda_function.py`
   - Ensure you have the required model JSON files in the models directory
   - Upload the model files to Lambda

3. **Configure Environment Variables**
   - Set `DEFAULT_GUARDRAIL_NAME` to your preferred guardrail name
   - Set `AR_POLICY` to your Automated Reasoning policy ID

4. **Update IAM Permissions**
   - Ensure your Lambda execution role has permissions for:
     - `bedrock:CreateGuardrail`
     - `bedrock:ListGuardrails`
     - `bedrock:ApplyGuardrail`
     - `bedrock:InvokeModel`

## Using the Sample

The Lambda function accepts a JSON event with the following structure:

```json
{
  "query": "I am a part-time employee, am I eligible for LoAP?",
  "response": "Yes, part time employees are allowed to use LoAP",
  "include_corrected_response": true
}
```

Parameters:
- `query`: The original question asked by the user
- `response`: The response to validate against Automated Reasoning policies
- `include_corrected_response`: (Optional, default: true) Whether to generate a corrected response when violations are found

## Understanding the Output

The function returns a JSON response with:

```json
{
  "input": [
    {"text": {"text": "original query", "qualifiers": ["query"]}},
    {"text": {"text": "response to check", "qualifiers": ["guard_content"]}}
  ],
  "automatedReasoning": {
    "findings": [
      {
        "result": "INVALID",
        "rules": [...],
        "suggestions": [...]
      }
    ]
  },
  "corrected_response": "Improved response text that addresses the issues"
}
```

Key components:
- `input`: The content submitted for validation
- `automatedReasoning`: Detailed findings from policy evaluation
  - `result`: Can be "VALID" or "INVALID"
  - `rules`: Rules that were violated
  - `suggestions`: Suggested corrections
- `corrected_response`: An improved response generated by LLM that addresses the issues found (if requested)

## How It Works

1. The Lambda function loads custom Amazon Bedrock service models to access private preview features
2. It creates or retrieves an Automated Reasoning guardrail
3. The guardrail validates the response against logical policy rules
4. If violations are found, the function can generate a corrected response using Claude 3 Haiku
5. The function returns detailed validation results and the corrected response

## Notes

- Automated Reasoning is currently a private preview feature in AWS Bedrock
- This sample requires custom service model files that may need to be updated as the service evolves
- The function has several configuration variables (DEFAULT_GUARDRAIL_NAME, AR_POLICY, REGION) that can be set as Lambda environment variables rather than hardcoded
- The function is configured for the US West (Oregon) region by default
- The corrected response generation is optional and can be disabled by setting `include_corrected_response` to false